---
description: Flutter securityルール（秘密情報・認証認可・入力検証・モバイル脆弱性）
globs: lib/**/*.dart,android/**,ios/**,server/**/*.dart,backend/**/*.dart
alwaysApply: true
---

# Security Rules (Flutter / Android / iOS)

## Security Prompt Intent

AIは security 観点で、次を必ず説明する:

- どの脅威に対する対策か（漏えい、改ざん、なりすまし等）
- 入力点・保存先・通信経路のどこを保護したか
- 追加した検証と残るリスク

## 秘密情報管理

- APIキー、トークン、秘密鍵をハードコードしない。
- `.env` / Secret Manager / CI Secrets を使い、コードに直書きしない。
- ログに個人情報・アクセストークンを出力しない。
- 流出が判明した秘密情報は失効・ローテーションを前提に対応する。

## 認証・認可

- アクセストークンは安全なストレージ（例: secure storage）を利用する。
- 期限切れトークン時の再認証フローを明示し、無限リトライを防ぐ。
- 権限チェックは UI だけでなく API 側でも実施する。

## 入力検証と通信

- ユーザー入力はクライアント/サーバー双方で検証する。
- HTTPS を前提とし、証明書エラーを握りつぶさない。
- 必要に応じて証明書ピンニングを検討する。
- サーバー側はパラメータ化クエリ等で注入攻撃を防止する。

## Android/iOS 固有対策

- Android: エクスポートコンポーネント、バックアップ設定、デバッグ設定を見直す。
- iOS: ATS 設定、権限説明文（Info.plist）、Keychain 利用方針を明確化する。
- クリップボード、スクリーンショット、バックグラウンド遷移時の情報露出を抑制する。

## 依存脆弱性と更新

- 依存モジュールは最新安定版を採用し、既知脆弱性を放置しない。
- 依存更新は定期実施し、破壊的変更はテストで吸収する。

## 重大問題検出時の優先順位

1. CRITICAL（秘密情報漏えい、認可欠落、平文保存）を最優先で修正する。
2. HIGH（入力検証不足、危険な権限設定）を次に修正する。
3. 修正後は再発防止テストを追加する。

## 参照ルール

- 詳細レビュー手順は `security/flutter-security-review.mdc` を参照する。
- 実装後検証は `common/flutter-verification.mdc` に従う。

## セキュリティチェックリスト

- [ ] ハードコードされた秘密情報がない
- [ ] 入力値検証が境界で実装されている
- [ ] 認証・認可の抜け道がない
- [ ] 通信・保存データの保護方針が明示されている
- [ ] 依存の既知脆弱性が放置されていない
